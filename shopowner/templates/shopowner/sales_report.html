{% extends 'bar.html' %}
{% block title %}üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="report-switch">
    <button onclick="location.href='/shopowner/sales_report/'">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button>
    <button onclick="location.href='/shopowner/stock_report/'">üì¶ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
</div>

<!-- üîπ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
<label for="start-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
<input type="date" id="start-date">

<label for="end-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
<input type="date" id="end-date">

<button onclick="fetchSalesReport()">üîç ‡πÅ‡∏™‡∏î‡∏á</button>

<!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
<div id="total-sales-amount" style="margin-top: 10px; font-size: 25px; font-weight: bold;">
    ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0.00 ‡∏ö‡∏≤‡∏ó
</div>

<!-- üîπ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ -->
<table border="1">
    <thead>
        <tr>
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
            <th>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        </tr>
    </thead>
    <tbody id="sales-table-body">
        <tr><td colspan="6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á"</td></tr>
    </tbody>
</table>

<!-- üîπ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ -->
<div id="pagination">
    <button id="prev-page" onclick="changePage(-1)" disabled>‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="current-page">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
    <button id="next-page" onclick="changePage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
</div>

<!-- ‚úÖ Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à -->
<div id="saleDetailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à #<span id="modal-sale-id"></span></h2>
        <table border="1">
            <thead>
                <tr>
                    <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                </tr>
            </thead>
            <tbody id="modal-sale-items">
                <tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
table {
    width: 100%;
    table-layout: fixed; /* üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
}
th, td {
    text-align: center;
    white-space: nowrap; /* üî• ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    overflow: hidden;
    text-overflow: ellipsis;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}
.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 50%;
}
.close {
    color: red;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
button {
    margin: 5px;
    padding: 5px 10px;
    cursor: pointer;
}
</style>

<script>
let currentPage = 1;
let totalPages = 1;

function fetchSalesReport(page = 1) {
    let startDate = document.getElementById("start-date").value;
    let endDate = document.getElementById("end-date").value;
    let tableBody = document.getElementById("sales-table-body");
    let totalSalesAmountDiv = document.getElementById("total-sales-amount");
    
    if (!startDate || !endDate) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö!");
        return;
    }

    fetch(`/shopowner/sales_report_by_range/?start_date=${startDate}&end_date=${endDate}&page=${page}`)
        .then(response => response.json())
        .then(data => {
            console.log("üîç API Response:", data);
            tableBody.innerHTML = ""; 

            if (data.success && data.sales.length > 0) {
                data.sales.forEach((sale, index) => {
                    let row = `<tr>
                        <td>${index + 1 + (page - 1) * 50}</td>
                        <td>${sale.sale__id}</td>
                        <td>${sale.sale__sale_date}</td>
                        <td>${sale.total_items}</td>
                        <td>${parseFloat(sale.total_amount).toFixed(2)}</td>
                        <td><button onclick="viewSaleDetail('${sale.sale__id}')">üìÑ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                totalSalesAmountDiv.innerHTML = `<strong>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${parseFloat(data.total_sales_amount).toFixed(2)} ‡∏ö‡∏≤‡∏ó</strong>`;

                currentPage = data.current_page;
                totalPages = data.total_pages;
                document.getElementById("current-page").textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}`;
                document.getElementById("prev-page").disabled = currentPage === 1;
                document.getElementById("next-page").disabled = currentPage >= totalPages;
            } else {
                tableBody.innerHTML = `<tr><td colspan="6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            }
        })
        .catch(error => {
            console.error("üö® Fetch Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        });
}

function viewSaleDetail(saleId) {
    console.log("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ID:", saleId);
    let modal = document.getElementById("saleDetailModal");
    let modalSaleId = document.getElementById("modal-sale-id");
    let modalSaleItems = document.getElementById("modal-sale-items");

    modalSaleId.innerText = saleId;
    modalSaleItems.innerHTML = "<tr><td colspan='4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

    fetch(`/shopowner/sale_detail/${saleId}/`)
        .then(response => response.json())
        .then(data => {
            modalSaleItems.innerHTML = "";
            if (data.success && data.items.length > 0) {
                data.items.forEach(item => {
                    let row = `<tr>
                        <td>${item.product__product_code}</td>
                        <td>${item.product__product_name}</td>
                        <td>${item.quantity}</td>
                        <td>${parseFloat(item.item_total).toFixed(2)}</td>
                    </tr>`;
                    modalSaleItems.innerHTML += row;
                });
            } else {
                modalSaleItems.innerHTML = "<tr><td colspan='4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ</td></tr>";
            }
        })
        .catch(error => {
            console.error("üö® Fetch Error:", error);
            modalSaleItems.innerHTML = `<tr><td colspan='4'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</td></tr>`;
        });

    modal.style.display = "block";
}

function closeModal() {
    document.getElementById("saleDetailModal").style.display = "none";
}

function changePage(step) {
    if ((step === -1 && currentPage > 1) || (step === 1 && currentPage < totalPages)) {
        currentPage += step;
        fetchSalesReport(currentPage);
    }
}
</script>
{% endblock %}
